# 3. ІНФОРМАЦІЙНЕ МОДЕЛЮВАННЯ ПРЕДМЕТНОЇ ОБЛАСТІ

Опис сутностей розглянутої предметної області, їх атрибутів і обмежень представлено в таблиці 3.1.

Таблиця 3.1 – Опис сутностей предметної області

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| users |  |  |
| id | Ідентифікатор користувача | Первинний ключ, BIGSERIAL |
| login | Логін (= ім'я PostgreSQL ролі) | До 50 символів, унікальне, не порожнє |
| email | Електронна пошта | До 255 символів, унікальне, не порожнє |
| phone | Номер телефону | До 20 символів, унікальне, не порожнє |
| full_name | Повне ім'я (ПІБ) | До 200 символів, не порожнє |
| registered_at | Дата та час реєстрації | TIMESTAMP, не порожнє, за замовчуванням now() |
| drivers |  |  |
| id | Ідентифікатор водія | Первинний ключ, BIGSERIAL |
| login | Логін водія (= ім'я PostgreSQL ролі) | До 50 символів, унікальне, не порожнє |
| email | Електронна пошта | До 255 символів, унікальне, не порожнє |
| phone | Номер телефону | До 20 символів, унікальне, не порожнє |
| full_name | Повне ім'я (ПІБ) | До 200 символів, не порожнє |
| driver_license_number | Номер водійського посвідчення | До 20 символів, унікальне, не порожнє |
| license_categories | Відкриті категорії прав | JSONB, не порожнє, за замовчуванням '[]' |
| passport_data | Паспортні дані | JSONB, не порожнє |
| transport_types |  |  |
| id | Ідентифікатор типу транспорту | Первинний ключ, BIGSERIAL |
| name | Назва типу (Автобус, Тролейбус, Трамвай) | До 50 символів, унікальне, не порожнє |

Продовження таблиці 3.1

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| vehicle_models |  |  |
| id | Ідентифікатор моделі | Первинний ключ, BIGSERIAL |
| name | Назва моделі (ЛАЗ, Богдан, Електрон) | До 255 символів, не порожнє |
| type_id | Тип транспорту | Зовнішній ключ на transport_types(id), не порожнє |
| capacity | Місткість (кількість пасажирів) | INTEGER, не порожнє, > 0 |
| vehicles |  |  |
| id | Ідентифікатор транспортного засобу | Первинний ключ, BIGSERIAL |
| fleet_number | Бортовий (інвентарний) номер | До 20 символів, унікальне, не порожнє |
| vehicle_model_id | Модель транспорту | Зовнішній ключ на vehicle_models(id) |
| route_id | Призначений маршрут | Зовнішній ключ на routes(id), не порожнє |
| routes |  |  |
| id | Ідентифікатор маршруту | Первинний ключ, BIGSERIAL |
| transport_type_id | Тип транспорту | Зовнішній ключ на transport_types(id), не порожнє |
| number | Номер маршруту (напр. "5А") | До 10 символів, не порожнє |
| direction | Напрямок руху | До 10 символів, не порожнє, IN ('forward', 'reverse') |
| is_active | Ознака активності маршруту | BOOLEAN, не порожнє, за замовчуванням true |
| stops |  |  |
| id | Ідентифікатор зупинки | Первинний ключ, BIGSERIAL |
| name | Назва зупинки | До 200 символів, не порожнє |
| lon | Довгота (longitude) | NUMERIC(10,7), не порожнє, >= -180 AND <= 180 |
| lat | Широта (latitude) | NUMERIC(10,7), не порожнє, >= -90 AND <= 90 |

Продовження таблиці 3.1

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| route_stops |  |  |
| id | Ідентифікатор запису | Первинний ключ, BIGSERIAL |
| route_id | Маршрут | Зовнішній ключ на routes(id), ON DELETE CASCADE, не порожнє |
| stop_id | Зупинка | Зовнішній ключ на stops(id), не порожнє |
| prev_route_stop_id | Попередня зупинка на маршруті | Зовнішній ключ на route_stops(id), унікальне, ON DELETE SET NULL |
| next_route_stop_id | Наступна зупинка на маршруті | Зовнішній ключ на route_stops(id), унікальне, ON DELETE SET NULL |
| distance_to_next_km | Відстань до наступної зупинки (км) | NUMERIC(10,3), >= 0 |
| route_points |  |  |
| id | Ідентифікатор точки | Первинний ключ, BIGSERIAL |
| route_id | Маршрут | Зовнішній ключ на routes(id), ON DELETE CASCADE, не порожнє |
| lon | Довгота | NUMERIC(10,7), не порожнє, >= -180 AND <= 180 |
| lat | Широта | NUMERIC(10,7), не порожнє, >= -90 AND <= 90 |
| prev_route_point_id | Попередня точка | Зовнішній ключ на route_points(id), унікальне, ON DELETE SET NULL |
| next_route_point_id | Наступна точка | Зовнішній ключ на route_points(id), унікальне, ON DELETE SET NULL |
| schedules |  |  |
| id | Ідентифікатор розкладу | Первинний ключ, BIGSERIAL |
| route_id | Маршрут | Зовнішній ключ на routes(id), не порожнє |
| vehicle_id | Транспортний засіб | Зовнішній ключ на vehicles(id) |
| work_start_time | Час початку роботи | TIME, не порожнє |
| work_end_time | Час закінчення роботи | TIME, не порожнє, > work_start_time |
| interval_min | Інтервал руху (хвилин) | INTEGER, не порожнє, > 0 |
| monday | Працює в понеділок | BOOLEAN, не порожнє, за замовчуванням false |
| tuesday | Працює у вівторок | BOOLEAN, не порожнє, за замовчуванням false |
| wednesday | Працює в середу | BOOLEAN, не порожнє, за замовчуванням false |
| thursday | Працює в четвер | BOOLEAN, не порожнє, за замовчуванням false |
| friday | Працює в п'ятницю | BOOLEAN, не порожнє, за замовчуванням false |
| saturday | Працює в суботу | BOOLEAN, не порожнє, за замовчуванням false |
| sunday | Працює в неділю | BOOLEAN, не порожнє, за замовчуванням false |

Продовження таблиці 3.1

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| trips |  |  |
| id | Ідентифікатор рейсу | Первинний ключ, BIGSERIAL |
| route_id | Маршрут | Зовнішній ключ на routes(id), не порожнє |
| driver_id | Водій | Зовнішній ключ на drivers(id), не порожнє |
| planned_starts_at | Плановий час початку | TIMESTAMP, не порожнє |
| planned_ends_at | Плановий час закінчення | TIMESTAMP |
| actual_starts_at | Фактичний час початку | TIMESTAMP |
| actual_ends_at | Фактичний час закінчення | TIMESTAMP, > actual_starts_at |
| status | Статус рейсу | До 20 символів, не порожнє, за замовчуванням 'scheduled', IN ('scheduled', 'in_progress', 'completed', 'cancelled') |
| passenger_count | Кількість пасажирів | INTEGER, не порожнє, за замовчуванням 0, >= 0 |
| driver_vehicle_assignments |  |  |
| id | Ідентифікатор призначення | Первинний ключ, BIGSERIAL |
| driver_id | Водій | Зовнішній ключ на drivers(id), ON DELETE CASCADE, не порожнє |
| vehicle_id | Транспортний засіб | Зовнішній ключ на vehicles(id), ON DELETE CASCADE, не порожнє |
| assigned_at | Дата та час призначення | TIMESTAMP, не порожнє, за замовчуванням now() |
| transport_cards |  |  |
| id | Ідентифікатор картки | Первинний ключ, BIGSERIAL |
| user_id | Власник картки | Зовнішній ключ на users(id), ON DELETE CASCADE, унікальне, не порожнє |
| balance | Поточний баланс (грн) | NUMERIC(12,2), не порожнє, за замовчуванням 0, >= 0 |
| card_number | Номер картки | До 20 символів, унікальне, не порожнє |

Продовження таблиці 3.1

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| card_top_ups |  |  |
| id | Ідентифікатор поповнення | Первинний ключ, BIGSERIAL |
| card_id | Картка | Зовнішній ключ на transport_cards(id), не порожнє |
| amount | Сума поповнення (грн) | NUMERIC(12,2), не порожнє, > 0 |
| topped_up_at | Дата та час поповнення | TIMESTAMP, не порожнє, за замовчуванням now() |
| tickets |  |  |
| id | Ідентифікатор квитка | Первинний ключ, BIGSERIAL |
| trip_id | Рейс | Зовнішній ключ на trips(id), не порожнє |
| card_id | Транспортна картка | Зовнішній ключ на transport_cards(id), не порожнє |
| price | Вартість квитка (грн) | NUMERIC(12,2), не порожнє, >= 0 |
| purchased_at | Дата та час покупки | TIMESTAMP, не порожнє, за замовчуванням now() |
| fines |  |  |
| id | Ідентифікатор штрафу | Первинний ключ, BIGSERIAL |
| user_id | Пасажир-порушник | Зовнішній ключ на users(id), не порожнє |
| status | Статус штрафу | До 50 символів, не порожнє, IN ('Очікує сплати', 'В процесі', 'Оплачено', 'Відмінено', 'Прострочено') |
| amount | Сума штрафу (грн) | NUMERIC(12,2), не порожнє, > 0 |
| reason | Причина штрафу | До 500 символів, не порожнє |
| issued_by | Логін контролера | До 50 символів, не порожнє, за замовчуванням current_user |
| trip_id | Рейс, під час якого виписано | Зовнішній ключ на trips(id), не порожнє |
| issued_at | Дата та час виписування | TIMESTAMP, не порожнє, за замовчуванням now() |
| paid_at | Дата та час оплати | TIMESTAMP |
| fine_appeals |  |  |
| id | Ідентифікатор апеляції | Первинний ключ, BIGSERIAL |
| fine_id | Штраф, що оскаржується | Зовнішній ключ на fines(id), ON DELETE CASCADE, унікальне, не порожнє |
| message | Текст апеляції | До 2000 символів, не порожнє |
| status | Статус розгляду | До 50 символів, не порожнє, IN ('Подано', 'Перевіряється', 'Відхилено', 'Прийнято') |
| created_at | Дата та час подання | TIMESTAMP, не порожнє, за замовчуванням now() |

Продовження таблиці 3.1

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| budgets |  |  |
| id | Ідентифікатор бюджету | Первинний ключ, BIGSERIAL |
| month | Місяць бюджету (перше число місяця) | DATE, унікальне, не порожнє |
| planned_income | Планові доходи (грн) | NUMERIC(14,2), не порожнє, за замовчуванням 0, >= 0 |
| planned_expenses | Планові витрати (грн) | NUMERIC(14,2), не порожнє, за замовчуванням 0, >= 0 |
| actual_income | Фактичні доходи (грн) | NUMERIC(14,2), не порожнє, за замовчуванням 0, >= 0 |
| actual_expenses | Фактичні витрати (грн) | NUMERIC(14,2), не порожнє, за замовчуванням 0, >= 0 |
| note | Примітка | До 500 символів |
| salary_payments |  |  |
| id | Ідентифікатор виплати | Первинний ключ, BIGSERIAL |
| driver_id | Водій-отримувач | Зовнішній ключ на drivers(id), не порожнє |
| rate | Ставка (грн/од.) | NUMERIC(12,2), > 0 |
| units | Кількість одиниць (годин/змін) | INTEGER, > 0 |
| total | Загальна сума виплати (грн) | NUMERIC(12,2), не порожнє, > 0 |
| paid_at | Дата та час виплати | TIMESTAMP, не порожнє, за замовчуванням now() |
| financial_transactions |  |  |
| id | Ідентифікатор транзакції | Первинний ключ, BIGSERIAL |
| tx_type | Тип операції | TEXT, не порожнє, IN ('income', 'expense') |
| source | Джерело операції | TEXT, не порожнє, IN ('ticket', 'fine', 'government', 'other', 'salary', 'fuel', 'maintenance', 'other_expense') |
| amount | Сума операції (грн) | NUMERIC(12,2), не порожнє, > 0 |
| occurred_at | Дата та час операції | TIMESTAMP, не порожнє, за замовчуванням now() |
| description | Опис операції | TEXT |
| created_by | Логін користувача, що створив запис | TEXT, не порожнє, за замовчуванням current_user |
| ticket_id | Квиток (для доходів від квитків) | Зовнішній ключ на tickets(id), ON DELETE SET NULL |
| fine_id | Штраф (для доходів від штрафів) | Зовнішній ключ на fines(id), ON DELETE SET NULL |
| salary_payment_id | Виплата ЗП (для витрат на ЗП) | Зовнішній ключ на salary_payments(id), ON DELETE SET NULL |
| trip_id | Рейс (контекст) | Зовнішній ключ на trips(id), ON DELETE SET NULL |
| route_id | Маршрут (контекст) | Зовнішній ключ на routes(id), ON DELETE SET NULL |
| driver_id | Водій (контекст) | Зовнішній ключ на drivers(id), ON DELETE SET NULL |
| card_id | Транспортна картка (контекст) | Зовнішній ключ на transport_cards(id), ON DELETE SET NULL |
| user_id | Користувач (контекст) | Зовнішній ключ на users(id), ON DELETE SET NULL |
| budget_month | Місяць бюджету для агрегації | Зовнішній ключ на budgets(month), ON DELETE SET NULL |

Продовження таблиці 3.1

| Ім'я атрибута | Призначення атрибута | Обмеження |
| ----- | ----- | ----- |
| complaints_suggestions |  |  |
| id | Ідентифікатор звернення | Первинний ключ, BIGSERIAL |
| user_id | Автор (якщо авторизований) | Зовнішній ключ на users(id) |
| type | Тип звернення | До 50 символів, не порожнє, IN ('complaint', 'suggestion') |
| message | Текст звернення | До 2000 символів, не порожнє |
| trip_id | Рейс (якщо стосується) | Зовнішній ключ на trips(id) |
| route_id | Маршрут (якщо стосується) | Зовнішній ключ на routes(id) |
| vehicle_id | Транспортний засіб (якщо стосується) | Зовнішній ключ на vehicles(id) |
| contact_info | Контактна інформація | До 200 символів |
| status | Статус розгляду | До 50 символів, не порожнє, IN ('Подано', 'Розглядається', 'Розглянуто') |
| created_at | Дата та час створення | TIMESTAMP, не порожнє, за замовчуванням now() |
| user_gps_logs |  |  |
| id | Ідентифікатор запису | Первинний ключ, BIGSERIAL |
| user_id | Користувач | Зовнішній ключ на users(id), ON DELETE CASCADE, не порожнє |
| lon | Довгота | NUMERIC(10,7), не порожнє, >= -180 AND <= 180 |
| lat | Широта | NUMERIC(10,7), не порожнє, >= -90 AND <= 90 |
| recorded_at | Дата та час запису | TIMESTAMP, не порожнє, за замовчуванням now() |
| vehicle_gps_logs |  |  |
| id | Ідентифікатор запису | Первинний ключ, BIGSERIAL |
| vehicle_id | Транспортний засіб | Зовнішній ключ на vehicles(id), ON DELETE CASCADE, не порожнє |
| lon | Довгота | NUMERIC(10,7), не порожнє, >= -180 AND <= 180 |
| lat | Широта | NUMERIC(10,7), не порожнє, >= -90 AND <= 90 |
| recorded_at | Дата та час запису | TIMESTAMP, не порожнє, за замовчуванням now() |

---

Опис усіх зв'язків між сутностями:

1) Зв'язок між користувачами та транспортними картками. Один користувач може мати одну транспортну картку. Для формалізації цього зв'язку використано унікальне обмеження на user_id у таблиці transport_cards.

2) Зв'язок між транспортними картками та поповненнями. Одна картка може мати багато поповнень. Кожне поповнення належить одній картці. Отже, існує зв'язок один-до-багатьох.

3) Зв'язок між транспортними картками та квитками. Одна картка може мати багато придбаних квитків. Кожен квиток прив'язаний до однієї картки. Отже, існує зв'язок один-до-багатьох.

4) Зв'язок між користувачами та штрафами. Один користувач може мати багато штрафів. Кожен штраф виписаний одному користувачу. Отже, існує зв'язок один-до-багатьох.

5) Зв'язок між штрафами та апеляціями. Один штраф може мати одну апеляцію. Для формалізації цього зв'язку використано унікальне обмеження на fine_id у таблиці fine_appeals.

6) Зв'язок між типами транспорту та моделями. Один тип транспорту може мати багато моделей. Кожна модель належить одному типу. Отже, існує зв'язок один-до-багатьох.

7) Зв'язок між моделями та транспортними засобами. Одна модель може мати багато транспортних засобів. Кожен ТЗ належить одній моделі. Отже, існує зв'язок один-до-багатьох.

8) Зв'язок між маршрутами та транспортними засобами. Один маршрут може мати багато призначених ТЗ. Кожен ТЗ призначений на один маршрут. Отже, існує зв'язок один-до-багатьох.

9) Зв'язок між маршрутами та зупинками. Один маршрут може проходити через багато зупинок. Одна зупинка може належати багатьом маршрутам. Для формалізації цього зв'язку використано проміжну таблицю route_stops з двозв'язним списком для збереження порядку.

10) Зв'язок між маршрутами та точками геометрії. Один маршрут має багато точок для відображення на карті. Для збереження порядку використано двозв'язний список у таблиці route_points.

11) Зв'язок між маршрутами та рейсами. Один маршрут може мати багато рейсів. Кожен рейс виконується на одному маршруті. Отже, існує зв'язок один-до-багатьох.

12) Зв'язок між водіями та рейсами. Один водій може виконувати багато рейсів. Кожен рейс виконується одним водієм. Отже, існує зв'язок один-до-багатьох. Додатково, частковий унікальний індекс забезпечує правило "один водій — один активний рейс".

13) Зв'язок між водіями та транспортними засобами. Один водій може бути призначений на багато ТЗ (з часом). Один ТЗ може мати багато призначених водіїв (з часом). Для формалізації використано таблицю driver_vehicle_assignments.

14) Зв'язок між рейсами та квитками. Один рейс може мати багато проданих квитків. Кожен квиток прив'язаний до одного рейсу. Отже, існує зв'язок один-до-багатьох.

15) Зв'язок між водіями та виплатами зарплати. Один водій може отримувати багато виплат. Кожна виплата призначена одному водію. Отже, існує зв'язок один-до-багатьох.

16) Зв'язок фінансових транзакцій з іншими сутностями. Таблиця financial_transactions має множинні nullable FK для зв'язку з квитками, штрафами, виплатами ЗП, рейсами, маршрутами, водіями, картками, користувачами та бюджетами для забезпечення повного аудиту фінансових операцій.
