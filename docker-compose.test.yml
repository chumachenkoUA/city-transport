services:
  db-test:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_USER: ct_migrator
      POSTGRES_PASSWORD: CHANGE_ME
      POSTGRES_DB: city_transport_test
    volumes:
      - ./db/bootstrap.sql:/docker-entrypoint-initdb.d/01-bootstrap.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ct_migrator -d city_transport_test"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis-test:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://ct_migrator:CHANGE_ME@db-test:5432/city_transport_test
      DATABASE_URL_MIGRATOR: postgresql://ct_migrator:CHANGE_ME@db-test:5432/city_transport_test
      REDIS_URL: redis://redis-test:6379
      JWT_SECRET: test_secret
      SESSION_SECRET: test_session_secret
      SEED_ON_START: "false"
      DB_USER_POOL_MAX: "2"
      DB_USER_POOL_IDLE_MS: "30000"
    depends_on:
      db-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    command: >
      sh -c "pnpm run test:e2e:report"
